<!DOCTYPE html>
<html >
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"><link rel="modulepreload" href="/articles/persistent-archlinux-usb/_payload.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/entry.476c2a3d.js"><link rel="preload" as="style" href="/_nuxt/entry.5a9e0e05.css"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/default.1ebf35e3.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Header.98518493.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/Footer.0a4ff27a.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/_...slug_.875024eb.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRendererMarkdown.7dce214f.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.1dec55d2.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ContentRenderer.90ccd0af.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/asyncData.12037cf6.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/query.bbdf5012.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/index.65a31f1c.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/utils.5c0504c5.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseP.39ca5389.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH1.177e5f90.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCodeInline.0e98609b.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseA.c7a90093.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH2.ee0f2e7f.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseCode.a3e35d54.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseH3.9ebc8c1c.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseOl.80922511.js"><link rel="modulepreload" as="script" crossorigin href="/_nuxt/ProseLi.41ccabc6.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/ContentDoc.f946b6ec.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/ContentQuery.011c78a5.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/web-socket.9a52cdc6.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/light.09bfb3ef.js"><link rel="prefetch" as="script" crossorigin href="/_nuxt/error-component.16d7a6c7.js"><link rel="stylesheet" href="/_nuxt/entry.5a9e0e05.css"><style>pre code .line{display:block;min-height:1rem}</style></head>
<body ><div id="__nuxt"><body><!--[--><main class="flex flex-col min-h-screen bg-grayish font-display"><div class="bg-grayish py-3"><nav class="container mx-auto"><div class="mx-6 md:mx-12 px-2"><div class="flex justify-between text-gray-200 font-semibold"><div><a href="/" class="mr-2 text-white hover:text-blue-200"> Home </a></div><div><a href="/articles" class="mr-2 text-white hover:text-blue-200"> Blog </a><a href="/playground" class="mr-2 text-white hover:text-blue-200"><svg class="inline h-4 w-4 fill-current text-white hover:text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg></a><a href="https://github.com/cmpadden" class="mr-2"><svg class="inline h-4 w-4 fill-current text-white hover:text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M13.18 11.309c-.718 0-1.3.807-1.3 1.799 0 .994.582 1.801 1.3 1.801s1.3-.807 1.3-1.801c-.001-.992-.582-1.799-1.3-1.799zm4.526-4.683c.149-.365.155-2.439-.635-4.426 0 0-1.811.199-4.551 2.08-.575-.16-1.548-.238-2.519-.238-.973 0-1.945.078-2.52.238C4.74 2.399 2.929 2.2 2.929 2.2c-.789 1.987-.781 4.061-.634 4.426C1.367 7.634.8 8.845.8 10.497c0 7.186 5.963 7.301 7.467 7.301l1.734.002 1.732-.002c1.506 0 7.467-.115 7.467-7.301 0-1.652-.566-2.863-1.494-3.871zm-7.678 10.289h-.056c-3.771 0-6.709-.449-6.709-4.115 0-.879.31-1.693 1.047-2.369C5.537 9.304 7.615 9.9 9.972 9.9h.056c2.357 0 4.436-.596 5.664.531.735.676 1.045 1.49 1.045 2.369 0 3.666-2.937 4.115-6.709 4.115zm-3.207-5.606c-.718 0-1.3.807-1.3 1.799 0 .994.582 1.801 1.3 1.801.719 0 1.301-.807 1.301-1.801 0-.992-.582-1.799-1.301-1.799z"></path></svg></a></div></div></div></nav></div><main class="flex-1 mt-4"><!--[--><!--[--><div class="container mx-auto px-2"><div class="mx-6 md:mx-12"><article class="shadow-lg bg-gray-200 mb-10 p-10"><h1 class="font-bold text-3xl text-gray-700">Create a Persistent Arch Linux Bootable USB with Vagrant</h1><p class="text-sm text-gray-600 flex items-center mb-4">2020-01-09</p><article class="prose max-w-none"><!--[--><div><p><!--[-->When installing a linux distribution, it is common for the instructions to have
the user create a bootable USB, boot from the device, and proceed with the
installation procedure from that live medium. However, this blog post will
outline an alternative approach where a virtual machine created with Vagrant
will be used in favor of the live medium.<!--]--></p><h1 id="preface"><!--[-->Preface<!--]--></h1><p><!--[-->The original intention was to use Docker for this process -- leveraging the
<code><!--[-->--device<!--]--></code> flag and mounting the target USB device in the Docker container,
but the underlying hypervisor in Docker Desktop for Mac does not support this.
<sup><a href="https://docs.docker.com/docker-for-mac/docker-toolbox/" rel="nofollow"><!--[-->1<!--]--></a> <a href="https://github.com/moby/hyperkit" rel="nofollow"><!--[-->2<!--]--></a> <a href="https://github.com/docker/for-mac/issues/900" rel="nofollow"><!--[-->3<!--]--></a></sup> While there are workarounds using Docker
Machine, Vagrant felt like the path of least resistance.<!--]--></p><h1 id="instructions"><!--[-->Instructions<!--]--></h1><h2 id="create-an-arch-linux-virtual-machine-with-vagrant"><a href="#create-an-arch-linux-virtual-machine-with-vagrant"><!--[-->Create an Arch Linux Virtual Machine with Vagrant<!--]--></a></h2><p><!--[-->Get the latest Arch Linux image <sup><a href="https://app.vagrantup.com/archlinux/boxes/archlinux" rel="nofollow"><!--[-->4<!--]--></a></sup> from the Vagrant Cloud Box
Catalog.<!--]--></p><!--[--><pre><code>vagrant box add archlinux/archlinux
</code></pre><!--]--><p><!--[-->Determine the USB vendor information for the thumb-drive that we will
pass-through to the virtual machine. Using the <code><!--[-->VBoxManage<!--]--></code> utility that comes
with Virtual Box, list the devices, and make note of the Vendor and Product ID.<!--]--></p><!--[--><pre><code> VBoxManage list usbhost
</code></pre><!--]--><p><!--[-->Create a <code><!--[-->Vagrantfile<!--]--></code> with <code><!--[-->archlinx/archlinux<!--]--></code> as the target box, and the USB
device information that is passed through. <sup><a href="https://antonyjepson.wordpress.com/2012/01/26/quickly-attaching-usb-devices-to-virtualbox-guests-using-vboxmanage/" rel="nofollow"><!--[-->5<!--]--></a> <a href="https://gist.github.com/dscape/7d829c0c116ef419f963" rel="nofollow"><!--[-->6<!--]--></a></sup> Vagrant
offers a handy customization parameter <code><!--[-->vb.customize<!--]--></code> that calls the
<code><!--[-->VBoxManage<!--]--></code> command under-the-hood, allowing one to enable the guest machine
to access the host machine&#39;s USB devices.<!--]--></p><!--[--><pre><code># -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(&quot;2&quot;) do |config|
  config.vm.box = &quot;archlinux/archlinux&quot;
  config.vm.provider &quot;virtualbox&quot; do |vb|
    vb.name = &quot;archlinux&quot;
    vb.customize [&#39;modifyvm&#39;, :id, &#39;--usb&#39;, &#39;on&#39;]
    vb.customize [&#39;usbfilter&#39;, &#39;add&#39;, &#39;1&#39;, &#39;--target&#39;, :id, &#39;--name&#39;, &#39;SanDisk Ultra Fit&#39;, &#39;--vendorid&#39;, &#39;0x0781&#39;, &#39;--productid&#39;, &#39;0x5583&#39;]
  end
end
</code></pre><!--]--><p><!--[-->When virtual machine is brought up, the <code><!--[-->usbfilter<!--]--></code> is applied, and the guest
is able to access to the host machine&#39;s USB device that was specified in the
filter.<!--]--></p><p><!--[-->Start the machine, <code><!--[-->ssh<!--]--></code> into the guest, and list the devices to confirm that
the USB device is available (see: <code><!--[-->/dev/sdb<!--]--></code>).<!--]--></p><!--[--><pre><code>$ vagrant up
$ vagrant ssh
[vagrant@archlinux ~]$ lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda      8:0    0   20G  0 disk
â”œâ”€sda1   8:1    0  1.9G  0 part [SWAP]
â””â”€sda2   8:2    0 18.1G  0 part /
sdb      8:16   1 28.7G  0 disk
â””â”€sdb1   8:17   1    8G  0 part
</code></pre><!--]--><h2 id="install-arch-linux-on-the-usb-drive"><a href="#install-arch-linux-on-the-usb-drive"><!--[-->Install Arch Linux on the USB Drive<!--]--></a></h2><p><!--[-->The <a href="https://wiki.archlinux.org/index.php/Installation_guide" rel="nofollow"><!--[-->Arch Linux Installation Guide<!--]--></a> outlines the installation procedure in
great detail -- the following steps follow this closely with a few alteration
due to installing onto removable media.<!--]--></p><h3 id="partition-the-disk-uefi-with-gpt"><a href="#partition-the-disk-uefi-with-gpt"><!--[-->Partition the Disk (UEFI with GPT)<!--]--></a></h3><!--[--><pre><code>[root@archlinux ~]# fdisk /dev/sdb
</code></pre><!--]--><!--[--><pre><code>Command (m for help): p
Disk /dev/sdb: 28.66 GiB, 30752636928 bytes, 60063744 sectors
Disk model: Ultra Fit
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: gpt
Disk identifier: E1D6C445-1B79-AB4D-A442-FA4AD6DF4ECC

Device       Start      End  Sectors  Size Type
/dev/sdb1     2048  1050623  1048576  512M EFI System
/dev/sdb2  1050624 60063710 59013087 28.1G Linux filesystem

Filesystem/RAID signature on partition 1 will be wiped.
</code></pre><!--]--><h3 id="format-the-partitions"><a href="#format-the-partitions"><!--[-->Format the Partitions<!--]--></a></h3><p><!--[-->The UEFI specification mandates support for FAT file-systems, and FAT32 is
recommended for removable media. <sup><a href="https://wiki.archlinux.org/index.php/EFI_system_partition#Format_the_partition" rel="nofollow"><!--[-->7<!--]--></a></sup><!--]--></p><!--[--><pre><code>[root@archlinux ~]# pacman -Sy dosfstools
[root@archlinux ~]# mkfs.fat -F32 /dev/sdb1
</code></pre><!--]--><p><!--[-->As for the root partition, it is recommended to use <code><!--[-->ext4<!--]--></code> without a journal to
reduce the reads and writes to the file-system as this is detrimental to the
flash-based USB drive. <sup><a href="https://wiki.archlinux.org/index.php/Install_Arch_Linux_on_a_USB_key#Installation_tweaks" rel="nofollow"><!--[-->8<!--]--></a></sup><!--]--></p><!--[--><pre><code>[root@archlinux ~]# mkfs.ext4 -O &quot;^has_journal&quot; /dev/sdb2
</code></pre><!--]--><h3 id="mount-the-partitions-and-bootstrap-the-environment"><a href="#mount-the-partitions-and-bootstrap-the-environment"><!--[-->Mount the Partitions and Bootstrap the Environment<!--]--></a></h3><!--[--><pre><code>[root@archlinux ~]# mount /dev/sdb2 /mnt
[root@archlinux ~]# mkdir -p /mnt/boot/efi
[root@archlinux ~]# mount /dev/sdb1 /mnt/boot/efi
</code></pre><!--]--><!--[--><pre><code>[root@archlinux ~]# pacman -S arch-install-scripts
[root@archlinux ~]# pacstrap /mnt base linux linux-firmware
[root@archlinux ~]# genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</code></pre><!--]--><h3 id="configure-the-new-environment"><a href="#configure-the-new-environment"><!--[-->Configure the New Environment<!--]--></a></h3><!--[--><pre><code>[root@archlinux ~]# arch-chroot /mnt
</code></pre><!--]--><!--[--><pre><code>[root@archlinux /]# ln -sf /usr/share/zoneinfo/US/Eastern /etc/localtime
[root@archlinux /]# hwclock --systohc
[root@archlinux /]# sed -i &#39;s/#en_US.UTF-8/en_US.UTF-8/&#39; /etc/locale.gen
[root@archlinux /]# locale-gen
[root@archlinux /]# echo &quot;LANG=en_US.UTF-8&quot; &gt; /etc/locale.conf
</code></pre><!--]--><!--[--><pre><code>[root@archlinux /]# hostnamectl set-hostname usb
[root@archlinux /]# echo &quot;127.0.0.1        localhost&quot; &gt;&gt; /etc/hosts
[root@archlinux /]# echo &quot;::1              localhost&quot; &gt;&gt; /etc/hosts
</code></pre><!--]--><p><!--[-->Note, one difference here from a standard installation is that the
<code><!--[-->--removable<!--]--></code> flag is specified when installing the GRUB bootloader.
<sup><a href="https://wiki.archlinux.org/index.php/GRUB#UEFI_systems" rel="nofollow"><!--[-->10<!--]--></a></sup><!--]--></p><!--[--><pre><code>[root@archlinux /]# pacman -S grub
[root@archlinux /]# grub-install --target=x86_64-efi --efi-directory=/boot/efi  --removable --recheck
[root@usb /]# grub-mkconfig -o /boot/grub/grub.cfg
</code></pre><!--]--><p><!--[-->Shutdown the virtual machine, restart the host machine, and boot the newly
created Arch Linux thumb-drive!<!--]--></p><p><!--[-->ðŸŽ‰<!--]--></p><h2 id="side-note"><a href="#side-note"><!--[-->Side-note<!--]--></a></h2><p><!--[-->It was attempted to use the <code><!--[-->controlvm usbattach<!--]--></code> command to pass the USB
device to the guest machine, but this did not work as it expects the virtual
machine to already be running, and the <code><!--[-->vb.customize<!--]--></code> option runs prior to
booting the machine. <sup><a href="https://www.vagrantup.com/docs/virtualbox/configuration.html#vboxmanage-customizations" rel="nofollow"><!--[-->11<!--]--></a></sup><!--]--></p><!--[--><pre><code>Command: [&quot;controlvm&quot;, &quot;060a716b-1965-49e2-bc56-12beed5df716&quot;, &quot;usbattach36fc9e60-c465-11cf-8056-444553540000&quot;]

Stderr: VBoxManage.exe: error: Machine &#39;060a716b-1965-49e2-bc56-12beed5df716&#39; is not currently running.
</code></pre><!--]--><h2 id="references"><a href="#references"><!--[-->References<!--]--></a></h2><ol><!--[--><li><!--[--><a href="https://docs.docker.com/docker-for-mac/docker-toolbox/" rel="nofollow"><!--[-->Docker Desktop on Mac vs. Docker Toolbox<!--]--></a><!--]--></li><li><!--[--><a href="https://github.com/moby/hyperkit" rel="nofollow"><!--[-->GitHub - HyperKit<!--]--></a><!--]--></li><li><!--[--><a href="https://github.com/docker/for-mac/issues/900" rel="nofollow"><!--[-->GitHub - Docker for Mac - Issue #900<!--]--></a><!--]--></li><li><!--[--><a href="https://app.vagrantup.com/archlinux/boxes/archlinux" rel="nofollow"><!--[-->Vagrant Cloud - Arch Linux<!--]--></a><!--]--></li><li><!--[--><a href="https://antonyjepson.wordpress.com/2012/01/26/quickly-attaching-usb-devices-to-virtualbox-guests-using-vboxmanage/" rel="nofollow"><!--[-->Attaching USB Devices to VirtualBox Guests using VBoxManage<!--]--></a><!--]--></li><li><!--[--><a href="https://gist.github.com/dscape/7d829c0c116ef419f963" rel="nofollow"><!--[-->GitHub Gist - Vagrant USB Filter<!--]--></a><!--]--></li><li><!--[--><a href="https://wiki.archlinux.org/index.php/EFI_system_partition#Format_the_partition" rel="nofollow"><!--[-->Arch Linux Wiki - EFI System Partition - Format Partitions<!--]--></a><!--]--></li><li><!--[--><a href="https://wiki.archlinux.org/index.php/Install_Arch_Linux_on_a_USB_key#Installation_tweaks" rel="nofollow"><!--[-->Arch Linux Wiki - Arch Linux on USB - Installation Tweaks<!--]--></a><!--]--></li><li><!--[--><a href="https://wiki.archlinux.org/index.php/Installation_guide" rel="nofollow"><!--[-->Arch Linux Wiki - Installation Guide<!--]--></a><!--]--></li><li><!--[--><a href="https://wiki.archlinux.org/index.php/GRUB#UEFI_systems" rel="nofollow"><!--[-->Arch Linux Wiki - GRUB - UEFI Systems<!--]--></a><!--]--></li><li><!--[--><a href="https://www.vagrantup.com/docs/virtualbox/configuration.html#vboxmanage-customizations" rel="nofollow"><!--[-->Vagrant VBoxManage Customizations <!--]--></a><!--]--></li><!--]--></ol></div><!--]--></article></article></div></div><!--]--><!--]--></main><footer class="w-full p-4 text-xs text-center text-white bg-gradient-to-l from-blackish to-pink-600 pin-b"><div>Â© Colton Padden</div><div class="pb-2"> Made with <a href="https://nuxtjs.org/" class="underline hover:text-blue-400">NuxtJS</a> &amp; <a href="https://tailwindcss.com/" class="underline hover:text-blue-400">tailwindcss</a></div></footer></main><!--]--></body></div><script type="module">import p from "/articles/persistent-archlinux-usb/_payload.js";window.__NUXT__={...p,...((function(a,b){return {state:{},_errors:{},serverRendered:true,config:{public:{content:{locales:[],integrity:1672496510490,experimental:{stripQueryParameters:a,clientDB:a},api:{baseURL:"\u002Fapi\u002F_content"},navigation:{fields:[]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"prose-code",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:a,wsUrl:b,documentDriven:a,anchorLinks:{depth:4,exclude:[1]}}},app:{baseURL:"\u002F",buildAssetsDir:"\u002F_nuxt\u002F",cdnURL:b}},prerenderedAt:1672496537896}}(false,"")))}</script><script type="module" src="/_nuxt/entry.476c2a3d.js" crossorigin></script><script type="module" src="/_nuxt/default.1ebf35e3.js" crossorigin></script><script type="module" src="/_nuxt/Header.98518493.js" crossorigin></script><script type="module" src="/_nuxt/_...slug_.875024eb.js" crossorigin></script><script type="module" src="/_nuxt/Footer.0a4ff27a.js" crossorigin></script><script type="module" src="/_nuxt/ContentRenderer.90ccd0af.js" crossorigin></script><script type="module" src="/_nuxt/ContentRendererMarkdown.7dce214f.js" crossorigin></script><script type="module" src="/_nuxt/ProseP.39ca5389.js" crossorigin></script><script type="module" src="/_nuxt/ProseH1.177e5f90.js" crossorigin></script><script type="module" src="/_nuxt/ProseCodeInline.0e98609b.js" crossorigin></script><script type="module" src="/_nuxt/ProseA.c7a90093.js" crossorigin></script><script type="module" src="/_nuxt/ProseH2.ee0f2e7f.js" crossorigin></script><script type="module" src="/_nuxt/ProseCode.a3e35d54.js" crossorigin></script><script type="module" src="/_nuxt/ProseH3.9ebc8c1c.js" crossorigin></script><script type="module" src="/_nuxt/ProseOl.80922511.js" crossorigin></script><script type="module" src="/_nuxt/ProseLi.41ccabc6.js" crossorigin></script></body>
</html>